{% extends "base.html" %}

{% block title %}Merge PDFs - Combine Multiple Documents{% endblock %}
{% block ogtitle %}Merge PDFs - Combine Multiple Documents{% endblock %}
{% block ogdescription %}Easily combine multiple PDF files into a single document. Merge reports, presentations, and documents in the order you choose.{% endblock %}
{% block canonical %}merge-pdf{% endblock %}

{% block content %}
<section class="hero" aria-label="Main banner">
    <div class="hero-content">
        <h1>Merge PDF Files</h1>
        <p class="hero-description">Upload multiple PDF files to combine them into a single document. Files will be merged in the order you choose.</p>
    </div>
</section>

<section class="tool-section">
    <div class="tool-container">
        <div class="tool-header">
            <div class="tool-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 16H6C4.89543 16 4 15.1046 4 14V6C4 4.89543 4.89543 4 6 4H14C15.1046 4 16 4.89543 16 6V8M10 20H18C19.1046 20 20 19.1046 20 18V10C20 8.89543 19.1046 8 18 8H10C8.89543 8 8 8.89543 8 10V18C8 19.1046 8.89543 20 10 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h2>PDF Merger Tool</h2>
        </div>
        <p class="tool-description">Upload multiple PDF files and combine them into a single document. You can reorder files before merging by dragging them up or down.</p>
        
        <div class="merge-container">
            <div id="upload-section">
                <div class="file-upload-container" id="drop-area">
                    <label for="file-input" class="file-upload-label">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 15V3M12 3L8 7M12 3L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M4 13V18C4 19.1046 4.89543 20 6 20H18C19.1046 20 20 19.1046 20 18V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Drag and drop PDF files here, or click to select</span>
                        <input type="file" id="file-input" accept=".pdf" multiple class="file-upload-input">
                    </label>
                    <p class="file-selection-info" id="file-selection-info">No files selected</p>
                    <div class="upload-button-container">
                        <button id="upload-button" class="upload-button" disabled>Upload PDFs</button>
                    </div>
                </div>
            </div>
            
            <div id="file-list-section" class="hidden">
                <div class="controls-bar">
                    <div class="control-group">
                        <button id="add-more-files" class="control-button">Add More Files</button>
                        <button id="clear-files" class="control-button">Clear All</button>
                    </div>
                    <div class="action-group">
                        <button id="merge-button" class="cta-button">Merge PDFs & Download</button>
                    </div>
                </div>
                
                <div class="file-list-container">
                    <h3>Files to merge</h3>
                    <p class="file-instruction">Files will be merged in the order shown below. <strong>Drag files up or down to reorder them.</strong></p>
                    <ul id="file-list" class="file-list"></ul>
                </div>
                
                <div id="loading-indicator" class="loading-indicator hidden">
                    <div class="spinner"></div>
                    <p>Merging your PDFs...</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal dialog for messages -->
<div id="message-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Message</h3>
            <button id="close-modal" class="close-button">&times;</button>
        </div>
        <div class="modal-body">
            <p id="modal-message"></p>
        </div>
        <div class="modal-footer">
            <button id="modal-ok-button" class="cta-button">OK</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    // DOM elements
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    const mergeButton = document.getElementById('merge-button');
    const clearButton = document.getElementById('clear-files');
    const addMoreButton = document.getElementById('add-more-files');
    const loadingIndicator = document.getElementById('loading-indicator');
    const uploadSection = document.getElementById('upload-section');
    const fileListSection = document.getElementById('file-list-section');
    const messageModal = document.getElementById('message-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const closeModal = document.getElementById('close-modal');
    const modalOkButton = document.getElementById('modal-ok-button');
    const fileSelectionInfo = document.getElementById('file-selection-info');
    const uploadButton = document.getElementById('upload-button');
    
    // Variables
    let files = [];
    
    // Initialize sortable list
    const sortable = new Sortable(fileList, {
        animation: 150,
        ghostClass: 'file-item-ghost',
        handle: '.drag-handle',
        onEnd: function() {
            // Update files array to match the new order
            const newOrder = [];
            Array.from(fileList.children).forEach(item => {
                const index = parseInt(item.dataset.index);
                newOrder.push(files[index]);
            });
            files = newOrder;
            
            // Update data-index attributes
            updateFileIndices();
        }
    });
    
    // Event listeners
    dropArea.addEventListener('click', () => {
        // This is intentionally empty as the click is handled by the label
    });
    
    fileInput.addEventListener('change', handleFileChange);
    uploadButton.addEventListener('click', handleFileUpload);
    
    dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.add('dragover');
    });
    
    dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('dragover');
    });
    
    dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            
            // Trigger change event
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
        }
    });
    
    mergeButton.addEventListener('click', mergePDFs);
    clearButton.addEventListener('click', clearFiles);
    addMoreButton.addEventListener('click', () => {
        // Reset the file input to allow selecting the same files again
        fileInput.value = '';
        fileInput.click();
    });
    
    // Modal event listeners
    closeModal.addEventListener('click', () => {
        messageModal.classList.add('hidden');
    });
    
    modalOkButton.addEventListener('click', () => {
        messageModal.classList.add('hidden');
    });
    
    // Show modal with message
    function showModal(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        messageModal.classList.remove('hidden');
    }
    
    // Handle file change
    function handleFileChange(e) {
        if (e.target.files.length > 0) {
            let validFilesCount = 0;
            
            // Check if files are valid PDFs
            for (let i = 0; i < e.target.files.length; i++) {
                if (e.target.files[i].type === 'application/pdf') {
                    validFilesCount++;
                }
            }
            
            if (validFilesCount > 0) {
                fileSelectionInfo.textContent = `${validFilesCount} ${validFilesCount === 1 ? 'file' : 'files'} selected`;
                uploadButton.disabled = false;
            } else {
                fileSelectionInfo.textContent = 'No valid PDF files selected';
                uploadButton.disabled = true;
                showModal("Invalid Files", "Please select valid PDF files.");
            }
        } else {
            fileSelectionInfo.textContent = 'No files selected';
            uploadButton.disabled = true;
        }
    }
    
    // Handle file upload button click
    function handleFileUpload() {
        if (fileInput.files.length > 0) {
            handleFiles(fileInput.files);
        }
    }
    
    // Handle files
    function handleFiles(fileList) {
        let hasAddedFiles = false;
        
        for (let i = 0; i < fileList.length; i++) {
            const file = fileList[i];
            if (file.type === 'application/pdf') {
                addFile(file);
                hasAddedFiles = true;
            } else {
                showModal("Invalid File", `${file.name} is not a PDF file.`);
            }
        }
        
        if (hasAddedFiles) {
            // Show file list section if it's hidden
            if (uploadSection.classList.contains('hidden') === false) {
                uploadSection.classList.add('hidden');
                fileListSection.classList.remove('hidden');
            }
        }
        
        updateButtons();
    }
    
    function addFile(file) {
        // Add file to array
        const fileIndex = files.length;
        files.push(file);
        
        // Create list item
        const item = document.createElement('li');
        item.className = 'file-item';
        item.dataset.index = fileIndex;
        
        // Drag handle
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 9H16M8 15H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        `;
        
        // File info
        const fileInfo = document.createElement('div');
        fileInfo.className = 'file-info';
        
        const fileName = document.createElement('span');
        fileName.className = 'file-name';
        fileName.textContent = file.name;
        
        const fileSize = document.createElement('span');
        fileSize.className = 'file-size';
        fileSize.textContent = formatFileSize(file.size);
        
        fileInfo.appendChild(fileName);
        fileInfo.appendChild(fileSize);
        
        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-file';
        removeBtn.innerHTML = '&times;';
        removeBtn.title = 'Remove file';
        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            removeFile(item, fileIndex);
        });
        
        // Assemble item
        item.appendChild(dragHandle);
        item.appendChild(fileInfo);
        item.appendChild(removeBtn);
        fileList.appendChild(item);
    }
    
    function removeFile(item, index) {
        // Remove from DOM
        item.remove();
        
        // Remove from array
        files = files.filter((_, i) => i !== index);
        
        // Update indices
        updateFileIndices();
        
        // Update buttons
        updateButtons();
        
        // If no files left, show upload section again
        if (files.length === 0) {
            fileListSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
        }
    }
    
    function updateFileIndices() {
        Array.from(fileList.children).forEach((item, index) => {
            item.dataset.index = index;
        });
    }
    
    function updateButtons() {
        mergeButton.disabled = files.length < 2;
        clearButton.disabled = files.length === 0;
    }
    
    function clearFiles() {
        fileList.innerHTML = '';
        files = [];
        updateButtons();
        
        // Show upload section again
        fileListSection.classList.add('hidden');
        uploadSection.classList.remove('hidden');
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    async function mergePDFs() {
        if (files.length < 2) {
            showModal("Error", "Please add at least two PDF files to merge.");
            return;
        }
        
        // Show loading indicator
        loadingIndicator.classList.remove('hidden');
        
        // Create FormData
        const formData = new FormData();
        
        // Important: Use the correct format for the server
        // The server expects 'files[]' not 'files[0]', 'files[1]', etc.
        files.forEach(file => {
            formData.append('files[]', file);
        });
        
        try {
            const response = await fetch('/merge-pdfs', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            // Hide loading indicator
            loadingIndicator.classList.add('hidden');
            
            if (data.success) {
                // Download the merged PDF
                window.location.href = `/download/${data.merged_filename}`;
                
                // Clear the file list
                clearFiles();
            } else {
                showModal("Error", data.error || "Merging failed. Please try again.");
            }
        } catch (error) {
            console.error('Error merging PDFs:', error);
            loadingIndicator.classList.add('hidden');
            showModal("Error", "An error occurred while merging PDFs. Please try again.");
        }
    }
</script>

<style>
/* Additional styles for the merge page */
.drag-handle {
    cursor: grab;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 8px;
    color: var(--secondary-color);
}

.drag-handle:hover {
    color: var(--accent-color);
}

.file-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    background-color: white;
    transition: background-color 0.2s ease;
}

.file-item:hover {
    background-color: #f8f9fa;
}

.file-item-ghost {
    opacity: 0.6;
    background-color: #f0f0f0;
    border: 1px dashed var(--accent-color);
}

.file-info {
    flex: 1;
    margin: 0 10px;
    overflow: hidden;
}

.file-name {
    display: block;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-size {
    display: block;
    font-size: 0.8rem;
    color: var(--secondary-color);
}

.remove-file {
    background: none;
    border: none;
    color: var(--error-color);
    font-size: 1.25rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease;
}

.remove-file:hover {
    background-color: rgba(255, 118, 117, 0.1);
}

.cta-button {
    background-color: var(--accent-color);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.cta-button:hover:not(:disabled) {
    background-color: var(--hover-color);
    transform: translateY(-2px);
}

.cta-button:disabled {
    background-color: #d1d1d1;
    cursor: not-allowed;
}

/* Fix for file input */
.file-upload-input {
    position: absolute;
    width: 0.1px;
    height: 0.1px;
    opacity: 0;
    overflow: hidden;
    z-index: -1;
}

/* Modal styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal.hidden {
    display: none;
}

.modal-content {
    background-color: white;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    overflow: hidden;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--primary-color);
}

.close-button {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--secondary-color);
    cursor: pointer;
    padding: 0;
    line-height: 1;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
}

.upload-button-container {
    text-align: center;
    margin-top: 16px;
}

.upload-button {
    background-color: #6366f1;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0.7;
}

.upload-button:hover:not(:disabled) {
    opacity: 1;
    transform: translateY(-2px);
}

.upload-button:disabled {
    background-color: #a5a6f6;
    cursor: not-allowed;
}

.file-selection-info {
    text-align: center;
    margin-top: 8px;
    color: var(--secondary-color);
    font-size: 0.9rem;
}
</style>
{% endblock %} 